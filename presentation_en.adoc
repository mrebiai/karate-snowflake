= ğŸ¥‹ Karate  ğŸ¥° â„ï¸ Snowflake
:source-highlighter: highlight.js
:highlightjs-languages: gherkin
:icons: font

ğŸ‡«ğŸ‡· _Ne ratez pas votre SQL avec un test Karate_

ğŸ‡¬ğŸ‡§ _Don't break your SQL code with a Karate test_


== ğŸª„ Once upon a time... âœ¨
[%step]
A great data pipeline !

[%step]
image::images/data-pipeline-simple.png[]

[%notitle]
=== Lectra Context
image::diagrams/iot.svg[background,size=contain]

=== $ whoami ğŸ‘¨â€ğŸ’»
[%step]
* Mehdi REBIAI
* ğŸ§‘â€ğŸ”§ Tech Lead & Data Engineer @Lectra
* icon:github[] https://github.com/mrebiai
* https://github.com/lectra-tech/kapoeira[Kapoeira Maintainer]

=== A great pipeline... but sometimes... ğŸ˜¥
[%step]
Not so great... more complex

[%step]
image:images/data-pipeline-dirty.jpg[height=290] image:images/data-pipeline-complex.jpg[height=290]

=== ğŸ’¡We need Tests ğŸ¤— & QA ğŸ•µï¸ ğŸ›
[%step]
But also some tools...

== Let's talk about architecture ğŸ‘·
ETL vs ELT...

[%notitle]
=== ETL
image::diagrams/data-pipeline-etl.svg[background,size=contain]

=== image:images/snowflake-text.png[]
[%step]
* Data Cloud... DBMS++
* Snowpark, Stream/Task...
* STORAGE ğŸ’° dissociated from COMPUTE ğŸ’°ğŸ’°ğŸ’°
* Scalable COMPUTE

[.columns]
=== image:images/kapoeira-text.svg[width=100]
[.column]
[%step]
* Kafka IT tests (â˜• / ğŸ³)
* Gherkin & Cucumber (Scala)
* Code: https://github.com/lectra-tech/kapoeira[^]
* Slides: https://jvauchel.github.io/kapoeira-dance/[^]

[.column]
[%step]
video::ELFCAgdgSro[youtube, width=500]

=== Kapoeira - Example (1/2)
image::images/burger-factory.svg[width=800]

=== Kapoeira - Example (2/2)
[source, gherkin]
----
include::features/kapoeira/burger-factory.feature[]
----

[%notitle]
=== ELT
image::diagrams/data-pipeline-elt.svg[background,size=contain]

=== image:images/dbt-text.svg[width=200]
[%step]
* Python tool for data transformation
* SQL generation through Jinja2 templates
* Code: https://github.com/dbt-labs/dbt-utils[^]
* Since `v1.8`, https://docs.getdbt.com/docs/build/unit-tests[unit tests^]

[.columns]
=== image:images/karatelabs.png[width=200]
[.column]
[%step]
* REST API tests, and more... (â˜•)
* Gherkin
* Code: https://github.com/karatelabs/karate[^]

[.column]
[%step]
video::NYlPxd5dZOU[youtube, width=500]

=== Karate - Example
[source, gherkin]
----
include::features/karate/hello-world.feature[]
----

=== Karate - HTTP+++<br/>+++Snowflake - JDBC SQL+++<br/>+++ğŸ¤”
[%step]
* https://docs.snowflake.com/en/developer-guide/snowflake-rest-api/snowflake-rest-api[Snowflake REST API & Authentication^]
* https://docs.snowflake.com/developer-guide/snowflake-cli/index[Snowflake CLI^] (JWT generation,...)
* https://docs.snowflake.com/en/developer-guide/sql-api/index[Snowflake SQL API^]
* ğŸ˜ƒ

=== Karate/Snowflake - Example
[source, gherkin]
----
include::features/karate/select-v1.feature[]
----

[.columns]
=== Complex for a SELECT...ğŸ˜ +++<br/>+++Run Task & DBT ?ğŸ¤”
[.column]
image::diagrams/data-pipeline-elt.svg[width=500]

[.column]
[%step]
* Karate DSL extension - https://github.com/karatelabs/karate-examples[Examples^]
* `karate.exec(<any_command>)`
* ğŸ˜ƒ

[.columns]
== ğŸ’¡ `karate-connect`+++<br/>+++ğŸ§© extensions
[%step]
[.column width="65%"]
* â˜• `karate-connect-standalone.jar`
** â˜• `karate-core.jar` image:images/karatelabs.png[width=60]
** â˜• `karate-connect.jar` image:images/lectra.png[width=80]
*** ğŸ§© `snowflake`, `kubernetes`
*** +++<p style="color: lightgrey">+++ğŸ§© `rabbitmq`, `kafka`+++</p>+++

[%step]
[.column]
* ğŸ³ `karate-connect` 
** â˜• `karate-connect-standalone.jar`
** ğŸ› ï¸ `dbt`, `kubectl`, `snowflake-cli`

=== How to run ?
[%step]
.â˜•
[source, bash]
----
java -Dextensions=<ext1,ext2...> \
    -jar karate-connect-standalone.jar \
    <features_path> <optional_params...>
----

[%step]
.ğŸ³
[source, bash, indent=0]
----
docker run --rm \
  -v $(pwd)/<features_path>:/features \
  -v $(pwd)/<reports_path>:/target \
  -e KARATE_EXTENSIONS=<ext1,ext2...>  -e ... \
  karate-connect:latest <optional_params...>
----

=== How to customize ?
.`karate-config.js`
[source, javascript]
----
function fn() {
  const mySuperFunction = (input) => input.toUpperCase();
  return {
    "projectName": "mySuperProject",
    "myFunction": mySuperFunction
  };
}
----

See https://karatelabs.github.io/karate/#environment-specific-config[karate documentation^] for file location

[.columns]
=== `snowflake` extension config
[%step]
[.column]
--
[source, bash]
.`cli-config`
----
SNOWFLAKE_ACCOUNT=xxx.west-europe.azure
SNOWFLAKE_USER=MY_USER
SNOWFLAKE_PRIVATE_KEY_PATH=/my-path/private-key.pem
PRIVATE_KEY_PASSPHRASE=my-passphrase
----

[source, javascript]
----
{ 
  "account": "xxx.west-europe.azure",
  "user": "MY_USER",
  "privateKeyPath": "/my-path/private-key.pem",
  "privateKeyPassphrase": "my-passphrase"
}
----
--

[%step]
[.column]
--
.`snowflake-config`
[source, bash]
----
SNOWFLAKE_DATABASE=MY_DB
SNOWFLAKE_SCHEMA=MY_SCHEMA
SNOWFLAKE_ROLE=MY_ROLE
SNOWFLAKE_WAREHOUSE=MY_WH
----

[source, javascript]
----
{
  "database": "MY_DB",
  "schema": "MY_SCHEMA"
  "role": "MY_ROLE",
  "warehouse": "MY_WH"
}
----
--

=== `snowflake` extension
* Config with env vars, JS files...
* JWT generation
* SQL execution (with retry, timeout...)
* Upload CSV/JSON into Table
* Clone / Drop schema
* And more...ğŸ˜ƒ

=== Karate/Snowflake - Example
[source, gherkin]
----
include::features/karate/select-v2.feature[]
----

[.columns]
== Demo Time ğŸ¬
[%step]
[.column]
Kafka version+++<br/>+++image:images/burger-factory.svg[width=600]

[%step]
[.column]
Snowflake version+++<br/>+++image:diagrams/burger-factory.svg[width=400]

=== DDL
image::diagrams/ddl.svg[width=600]

=== How to run ?
[%step]
.â˜•
[source, bash, indent=0]
----
include::demo.sh[tags=karate_jar]
----

[%step]
.ğŸ³
[source, bash, indent=0]
----
include::demo.sh[tags=karate_docker]
----

=== `burger-factory.feature`
[source, gherkin]
----
include::burger_factory/it/features/burger-factory.feature[]
----

=== Clone schemas...
[source, gherkin]
----
include::burger_factory/it/features/burger-factory-clone-schemas.feature[]
----

== Next Steps ğŸš€
* Extension `kafka`
* Extension `jdbc`?

[background-color="white"]
[.columns]
== ğŸ‰ Thank you - Questions?+++<br/>+++ğŸ¥‹ğŸ¥°â„ï¸
[.column]
Slides ğŸ–¥ï¸::
image:images/qrcode-slides.png[width=300]

[.column]
FeedbackğŸ™::
image:images/qrcode-feedback.png[width=300]